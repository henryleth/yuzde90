server {
        listen      51.222.107.102:443 ssl;
        server_name turquiana.com ;
        error_log   /var/log/apache2/domains/turquiana.com.error.log error;

        ssl_certificate     /home/turquiana/conf/web/turquiana.com/ssl/turquiana.com.pem;
        ssl_certificate_key /home/turquiana/conf/web/turquiana.com/ssl/turquiana.com.key;
        ssl_stapling        on;
        ssl_stapling_verify on;

        # TLS 1.3 0-RTT anti-replay
        if ($anti_replay = 307) { return 307 https://$host$request_uri; }
        if ($anti_replay = 425) { return 425; }

        include /home/turquiana/web/turquiana.com/nginx.hsts.conf*;

        # Nokta ile başlayan gizli dosyaları kapat (.git, .env vs)
        location ~ /\.(?!well-known\/|file) {
                deny all;
                return 404;
        }

        ##### --- PERFORMANCE: GZIP + LONG CACHE + STATIC FROM NGINX --- #####

        # Sıkıştırma (brotli yoksa gzip yeterli)
        gzip on;
        gzip_comp_level 5;                 # orta seviye
        gzip_min_length 1024;              # 1KB üstü cevapları sıkıştır
        gzip_types
          text/plain
          text/css
          application/javascript
          application/json
          application/xml
          image/svg+xml;

        # Statik asset’ler (Vite build, görseller, fontlar) -> Nginx doğrudan servis eder
        # NOT: Proxy'ye göndermeden önce bu blok eşleşir; TTFB ve bant genişliği iyileşir.
        location ~* \.(?:js|mjs|css|woff2|woff|ttf|svg|png|jpe?g|gif|webp|avif|ico)$ {
                root /home/turquiana/web/turquiana.com/public_html/public;
                try_files $uri =404;              # yoksa 404; Apache'ye/proxy'ye düşmesin
                access_log off;                   # log şişirmesin
                expires 1y;                       # uzun tarayıcı önbelleği
                add_header Cache-Control "public, max-age=31536000, immutable";
        }

        # HTML dinamik kabul -> cache verme
        location ~* \.html$ {
                add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        ##### --- /PERFORMANCE --- #####

        # Tüm diğer istekler backend'e (Apache 8443) gider
        location / {
                proxy_ssl_server_name on;
                proxy_ssl_name $host;
                proxy_pass https://51.222.107.102:8443;

                # proxy header'ları (orijinal host ve IP’yi ilet)
                proxy_set_header Host              $host;
                proxy_set_header X-Real-IP         $remote_addr;
                proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Proxy fallback (Hestia şablonunda var; bıraktım)
        location @fallback {
                proxy_ssl_server_name on;
                proxy_ssl_name $host;
                proxy_pass https://51.222.107.102:8443;
        }

        # Hata sayfaları
        location /error/ {
                alias /home/turquiana/web/turquiana.com/document_errors/;
        }

        proxy_hide_header Upgrade;

        # Hestia'nın ek include'ları (elleme)
        include /home/turquiana/web/turquiana.com/nginx.ssl.conf_*;
}